<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUNA BIT - Ultimate Simulator</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
    /* --- 1. THEME DEFINITION (Bybit Dark Mode Accurate) --- */
    :root {
        --bg-base: #121212; 
        --bg-panel: #181a20; 
        --bg-sec: #252a35;
        --border: #262930; 
        --text-pri: #eaecef; 
        --text-sec: #848e9c;
        --up: #0ecb81; 
        --down: #f6465d; 
        --accent: #f7a600;
        --hover: #2a2e39; 
        --input-bg: #2b3139;
        --toast-bg: #2b3139;
        --font-num: 'Roboto Mono', 'Consolas', monospace; /* 숫자 전용 폰트 */
        --shadow-card: 0 4px 12px rgba(0,0,0,0.5);
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; user-select: none; }
    body { background: var(--bg-base); color: var(--text-pri); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 12px; }
    input, button { font-family: inherit; outline: none; border: none; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: var(--bg-base); }

    /* --- 2. HEADER SECTION --- */
    header { 
        height: 50px; background: var(--bg-panel); border-bottom: 1px solid #000; 
        display: flex; align-items: center; padding: 0 16px; flex-shrink: 0; justify-content: space-between; z-index: 100;
    }
    .logo { font-size: 18px; font-weight: 900; color: #fff; display: flex; align-items: center; gap: 6px; cursor: pointer; letter-spacing: -0.5px; }
    .logo span { color: var(--accent); }
    .logo svg { fill: var(--accent); width: 22px; height: 22px; }

    .ticker-group { display: flex; gap: 24px; margin-left: 30px; align-items: center; height: 100%; border-left: 1px solid var(--border); padding-left: 20px; }
    .tg-item { display: flex; flex-direction: column; justify-content: center; height: 100%; }
    .tg-label { font-size: 11px; color: var(--text-sec); font-weight: 600; margin-bottom: 2px; }
    .tg-val { font-size: 13px; font-weight: 700; font-family: var(--font-num); }
    .tg-val.up { color: var(--up); } .tg-val.down { color: var(--down); }

    .header-right { display: flex; align-items: center; gap: 15px; font-weight: 700; color: var(--text-sec); font-size: 11px; }
    .clock-badge { background: #000; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); font-family: var(--font-num); }

    /* --- 3. LAYOUT GRID --- */
    .layout { display: flex; flex: 1; overflow: hidden; position: relative; }
    .col-chart { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); min-width: 0; position: relative; }
    .col-ob { width: 290px; background: var(--bg-base); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
    .col-trade { width: 340px; background: var(--bg-panel); display: flex; flex-direction: column; flex-shrink: 0; }

    /* --- 4. CHART AREA --- */
    .chart-toolbar { height: 40px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; background: var(--bg-panel); gap: 4px; }
    .tf-btn { padding: 5px 10px; color: var(--text-sec); cursor: pointer; font-weight: 700; border-radius: 4px; transition: 0.1s; font-size: 12px; }
    .tf-btn:hover { background: var(--hover); color: var(--text-pri); }
    .tf-btn.active { color: var(--accent); background: rgba(247,166,0,0.1); }

    #chart-container { flex: 1; position: relative; cursor: crosshair; }
    #draw-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

    /* Drawing Tools (Floating Left) */
    .draw-tools { 
        position: absolute; left: 12px; top: 12px; display: flex; flex-direction: column; gap: 6px; 
        background: rgba(30,32,38,0.95); padding: 6px; border-radius: 6px; border: 1px solid var(--border); 
        z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    }
    .dt-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: var(--text-sec); cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 16px; }
    .dt-btn:hover { background: var(--hover); color: var(--text-pri); }
    .dt-btn.active { color: var(--accent); background: rgba(247, 166, 0, 0.15); border: 1px solid rgba(247, 166, 0, 0.3); }
    .dt-tooltip { position: absolute; left: 40px; background: #000; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; }
    .dt-btn:hover .dt-tooltip { opacity: 1; }

    /* P&L Badge (On Chart) */
    .pos-badge { 
        position: absolute; display: none; background: rgba(24,26,32, 0.95); 
        border: 1px solid var(--border); border-radius: 4px; z-index: 30; 
        font-size: 11px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
        white-space: nowrap; backdrop-filter: blur(2px); transform: translate(-50%, -100%); margin-top: -10px;
    }
    .pb-content { display: flex; }
    .pb-item { padding: 6px 10px; border-right: 1px solid var(--border); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pb-item span { font-size: 9px; color: var(--text-sec); margin-bottom: 2px; }
    .pb-item b { font-family: var(--font-num); }
    .pb-close { padding: 0 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-sec); transition: 0.2s; }
    .pb-close:hover { background: var(--down); color: #fff; }

    /* --- 5. ORDER BOOK (High Frequency) --- */
    .ob-header { 
        padding: 8px 12px; display: flex; justify-content: space-between; color: var(--text-sec); 
        font-size: 11px; font-weight: 700; border-bottom: 1px solid var(--border); background: var(--bg-panel); 
    }
    .ob-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #131722; position: relative; }
    .ob-list { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

    .ob-row { 
        display: flex; justify-content: space-between; padding: 1px 12px; 
        cursor: pointer; position: relative; height: 22px; align-items: center; 
        font-family: var(--font-num); font-size: 12px; font-weight: 600; 
        transition: background-color 0.05s;
    }
    .ob-row:hover { background: var(--hover); }

    /* Depth Bar & Flash */
    .bg-bar { position: absolute; top: 0; right: 0; height: 100%; opacity: 0.15; z-index: 0; transition: width 0.1s linear; }
    .bg-ask { background: var(--down); } .bg-bid { background: var(--up); }

    .ob-price { z-index: 1; width: 40%; text-align: left; }
    .ob-qty { z-index: 1; width: 30%; text-align: right; color: var(--text-pri); }
    .ob-total { z-index: 1; width: 30%; text-align: right; color: var(--text-sec); }

    .text-up { color: var(--up) !important; } .text-down { color: var(--down) !important; }

    .mid-stats { 
        height: 44px; display: flex; align-items: center; justify-content: center; 
        border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
        background: var(--bg-panel); flex-shrink: 0;
    }
    .mid-price { font-size: 20px; font-weight: 900; font-family: var(--font-num); margin-right: 8px; }
    .mid-arrow { font-size: 16px; }

    /* --- 6. TRADE FORM (Right Panel) --- */
    .trade-body { padding: 16px; display: flex; flex-direction: column; gap: 18px; flex: 1; overflow-y: auto; }

    .bal-display { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sec); font-weight: 600; }
    .bal-val { color: #fff; font-family: var(--font-num); }

    .margin-selector { 
        display: flex; align-items: center; justify-content: space-between; 
        background: var(--input-bg); border-radius: 6px; padding: 0 12px; height: 42px; 
        cursor: pointer; border: 1px solid transparent; transition: 0.2s; 
    }
    .margin-selector:hover { border-color: var(--text-sec); background: #363c45; }
    .ms-label { font-weight: 700; color: var(--text-pri); }
    .ms-val { font-weight: 800; color: var(--accent); }

    .inp-group { position: relative; }
    .inp-label { display: block; color: var(--text-sec); font-size: 11px; margin-bottom: 6px; font-weight: 600; }
    .inp-wrap { 
        display: flex; align-items: center; background: var(--input-bg); height: 42px; 
        border-radius: 6px; padding: 0 12px; border: 1px solid transparent; transition: 0.2s; 
    }
    .inp-wrap:focus-within { border-color: var(--accent); background: #121212; }
    .inp-wrap input { background: transparent; flex: 1; color: #fff; text-align: right; font-weight: 700; font-size: 15px; }
    .inp-suffix { color: var(--text-sec); font-size: 12px; margin-left: 8px; font-weight: 700; }

    /* Slider */
    .slider-container { margin-top: 5px; }
    input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; cursor: pointer; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
    input[type=range]::-webkit-slider-thumb { 
        -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; 
        background: var(--accent); margin-top: -6px; border: 2px solid #fff; 
        box-shadow: 0 0 8px rgba(247,166,0,0.5); transition: 0.2s; 
    }
    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
    .slider-marks { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-sec); margin-top: 6px; font-weight: 600; }

    .cost-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sec); font-weight: 600; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; }

    .trade-btns { display: flex; gap: 10px; margin-top: auto; }
    .btn-trade { 
        flex: 1; height: 48px; border-radius: 6px; font-weight: 800; font-size: 15px; 
        cursor: pointer; color: #fff; transition: 0.1s; position: relative; overflow: hidden; 
    }
    .btn-trade:active { transform: scale(0.98); }
    .btn-long { background: var(--up); } .btn-long:hover { background: #32d993; }
    .btn-short { background: var(--down); } .btn-short:hover { background: #ff5e74; }

    /* --- 7. BOTTOM PANEL (Positions) --- */
    .btm-panel { height: 280px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; flex-direction: column; }
    .btm-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-base); }
    .btm-tab { padding: 12px 24px; font-weight: 700; color: var(--text-sec); cursor: pointer; border-top: 2px solid transparent; background: var(--bg-panel); font-size: 13px; }
    .btm-tab.active { color: var(--text-pri); border-top-color: var(--accent); background: var(--bg-panel); }

    .btm-content { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { position: sticky; top: 0; background: var(--bg-base); color: var(--text-sec); padding: 10px 16px; font-size: 11px; text-align: left; border-bottom: 1px solid var(--border); z-index: 5; }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; color: var(--text-pri); }
    tr:hover td { background: var(--hover); }

    .pnl-cell { display: flex; flex-direction: column; }
    .pnl-krw { font-size: 11px; font-weight: 500; margin-top: 2px; opacity: 0.8; font-family: var(--font-num); }
    .btn-action { padding: 6px 12px; background: var(--input-bg); border-radius: 4px; cursor: pointer; font-size: 11px; border: 1px solid var(--border); color: #fff; font-weight: 700; transition: 0.2s; }
    .btn-action:hover { border-color: var(--accent); color: var(--accent); }

    /* --- 8. MODALS & TOAST --- */
    .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal { background: var(--bg-sec); width: 440px; border-radius: 12px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); border: 1px solid var(--border); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .m-head { display: flex; justify-content: space-between; font-size: 18px; font-weight: 800; color: #fff; margin-bottom: 24px; }
    .m-close { cursor: pointer; color: var(--text-sec); font-size: 20px; }
    .m-close:hover { color: #fff; }

    .mm-tabs { display: flex; background: var(--input-bg); border-radius: 6px; padding: 4px; margin-bottom: 24px; }
    .mm-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 4px; color: var(--text-sec); font-weight: 700; transition: 0.2s; }
    .mm-tab.active { background: var(--bg-sec); color: var(--text-pri); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

    .m-btn { width: 100%; height: 48px; background: var(--accent); color: #111; font-weight: 800; border-radius: 6px; cursor: pointer; margin-top: 20px; font-size: 15px; transition: 0.2s; }
    .m-btn:hover { filter: brightness(1.1); }

    #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #2b3139; color: #fff; padding: 14px 28px; border-radius: 8px; z-index: 2000; font-weight: 700; border-left: 5px solid var(--accent); display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="logo" ondblclick="resetData()" title="더블클릭 시 데이터 초기화">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5 9.5 9.75 12 11zm0 2.5l-5-2.5-5 2.5 10 5 10-5-5-2.5-5 2.5z"/></svg>
        LUNA <span>BIT</span>
    </div>
    <div class="ticker-group">
        <div class="tg-item"><span class="tg-label">KRW-BTC</span><span class="tg-val" id="head-price">--</span></div>
        <div class="tg-item"><span class="tg-label">24H 변동</span><span class="tg-val" id="head-chg">--%</span></div>
        <div class="tg-item"><span class="tg-label">24H 고가</span><span class="tg-val" id="head-high">--</span></div>
        <div class="tg-item"><span class="tg-label">24H 저가</span><span class="tg-val" id="head-low">--</span></div>
    </div>
    <div class="header-right">
        <span style="color:var(--up)">● Real-time Connected</span>
        <div class="clock-badge" id="clock">00:00:00</div>
    </div>
</header>

<div class="layout">
    <div class="col-chart">
        <div class="chart-toolbar">
            <div class="tf-btn active" onclick="setTF('1')">1m</div>
            <div class="tf-btn" onclick="setTF('5')">5m</div>
            <div class="tf-btn" onclick="setTF('15')">15m</div>
            <div class="tf-btn" onclick="setTF('60')">1H</div>
            <div class="tf-btn" onclick="setTF('240')">4H</div>
            <div class="tf-btn" onclick="setTF('D')">1D</div>
        </div>
        <div id="chart-container">
            <div class="draw-tools">
                <div class="dt-btn active" onclick="setTool('cursor')">➤<span class="dt-tooltip">선택</span></div>
                <div class="dt-btn" onclick="setTool('line')">／<span class="dt-tooltip">추세선</span></div>
                <div class="dt-btn" onclick="setTool('hline')">－<span class="dt-tooltip">가로줄</span></div>
                <div class="dt-btn" onclick="setTool('eraser')">✕<span class="dt-tooltip">지우개</span></div>
            </div>
            <canvas id="draw-layer"></canvas>
            <div class="pos-badge" id="pos-badge">
                <div class="pb-content">
                    <div class="pb-item"><span>P&L</span><b id="pb-pnl" class="text-up">+0.00</b></div>
                    <div class="pb-item"><span>Qty</span><b id="pb-qty">0.000</b></div>
                    <div class="pb-close" onclick="closePosition()">✕</div>
                </div>
            </div>
        </div>
        <div class="btm-panel">
            <div class="btm-tabs">
                <div class="btm-tab active">포지션 & 주문</div>
                <div class="btm-tab">체결 내역</div>
            </div>
            <div class="btm-content">
                <table id="pos-table">
                    <thead><tr><th>계약</th><th>수량</th><th>가치</th><th>진입가</th><th>현재가</th><th>청산가</th><th>미실현 손익 (ROE%)</th><th>실현 손익 (수수료)</th><th>TP/SL</th><th>종료</th></tr></thead>
                    <tbody id="pos-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-ob">
        <div class="ob-header"><span>가격(KRW)</span><span>수량(BTC)</span><span>합계</span></div>
        <div class="ob-container">
            <div class="ob-list" id="asks" style="flex-direction:column-reverse;"></div>
        </div>
        <div class="mid-stats" id="mid-stats">
            <span class="mid-price" id="mid-price">--</span>
            <span class="mid-arrow" id="mid-arrow"></span>
        </div>
        <div class="ob-container">
            <div class="ob-list" id="bids"></div>
        </div>
    </div>

    <div class="col-trade">
        <div class="ob-header" style="background:var(--bg-panel); border-bottom:1px solid var(--border);">
            <span style="color:var(--accent); border-bottom:2px solid var(--accent); padding-bottom:12px;">일반 주문</span><span>조건부 주문</span>
        </div>
        <div class="trade-body">
            <div class="bal-display"><span>사용 가능 자산</span><span class="bal-val"><span id="balance">10,000,000</span> KRW</span></div>
            
            <div class="margin-selector" onclick="openMarginModal()">
                <span class="ms-label" id="margin-type">Cross</span>
                <span class="ms-val" id="lev-disp">20x</span>
            </div>

            <div class="inp-group">
                <span class="inp-label">주문 가격</span>
                <div class="inp-wrap">
                    <input type="number" id="inp-price" placeholder="시장가">
                    <span class="inp-suffix">KRW</span>
                </div>
            </div>
            
            <div class="inp-group">
                <span class="inp-label">수량</span>
                <div class="inp-wrap">
                    <input type="number" id="inp-qty" oninput="syncSlider(this.value)">
                    <span class="inp-suffix">BTC</span>
                </div>
            </div>

            <div class="slider-container">
                <input type="range" id="slider-qty" min="0" max="100" value="0" step="1" oninput="setQtyPct(this.value)">
                <div class="slider-marks"><span>0%</span><span>50%</span><span>100%</span></div>
            </div>

            <div class="cost-row">
                <span>예상 비용</span>
                <span style="color:#fff; font-family:var(--font-num)" id="cost-disp">0 KRW</span>
            </div>

            <div class="trade-btns">
                <button class="btn-trade btn-long" onclick="openPos('long')">롱 오픈</button>
                <button class="btn-trade btn-short" onclick="openPos('short')">숏 오픈</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-mask" id="modal-margin">
    <div class="modal">
        <div class="m-head"><span>Margin Mode & Leverage</span><span class="m-close" onclick="closeModal('modal-margin')">✕</span></div>
        <div class="mm-tabs">
            <div class="mm-tab active" id="tab-cross" onclick="setMarginMode('Cross')">Cross (교차)</div>
            <div class="mm-tab" id="tab-isolated" onclick="setMarginMode('Isolated')">Isolated (격리)</div>
        </div>
        <div style="margin-bottom:30px">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:700; color:#ccc">Leverage</span><span style="color:var(--accent); font-weight:800; font-size:16px;" id="modal-lev-val">20x</span>
            </div>
            <input type="range" min="1" max="100" value="20" oninput="updateModalLev(this.value)">
        </div>
        <button class="m-btn" onclick="confirmMargin()">확인 (Confirm)</button>
    </div>
</div>

<div id="toast">알림 메시지</div>

<script>
// --- 0. SOUND ENGINE (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    
    if (type === 'buy' || type === 'sell') {
        osc.frequency.setValueAtTime(880, now);
        osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'close') {
        osc.frequency.setValueAtTime(1200, now);
        osc.type = 'triangle';
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.15);
        osc.start(now); osc.stop(now + 0.15);
    } else if (type === 'error') {
        osc.frequency.setValueAtTime(150, now);
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
    }
}

// --- 1. CORE CONFIG & STATE ---
const SYMBOL = "KRW-BTC";

let state = {
    price: 0,
    balance: 10000000,
    lev: 20,
    mode: 'Cross',
    pos: null, 
    drawings: [], 
    asks: [], bids: [],
    tf: '1' // Default to 1 minute
};

// --- 2. PERSISTENCE (LocalStorage) ---
function saveState() {
    const s = { 
        balance: state.balance, lev: state.lev, mode: state.mode, 
        pos: state.pos, drawings: state.drawings 
    };
    localStorage.setItem('upbit_pro_v1', JSON.stringify(s));
}

function loadState() {
    const s = localStorage.getItem('upbit_pro_v1');
    if (s) {
        const d = JSON.parse(s);
        state.balance = d.balance ?? 10000000;
        state.lev = d.lev ?? 20;
        state.mode = d.mode ?? 'Cross';
        state.pos = d.pos ?? null;
        state.drawings = d.drawings ?? [];
        
        document.getElementById('lev-disp').innerText = state.lev + "x";
        document.getElementById('margin-type').innerText = state.mode;
        updateBal();
        renderPosTable();
    }
}

function resetData() {
    localStorage.removeItem('upbit_pro_v1');
    showToast("데이터가 초기화되었습니다. 새로고침하세요.");
    setTimeout(() => location.reload(), 1000);
}

// --- 3. CHART ENGINE ---
const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
    layout: { backgroundColor: '#121212', textColor: '#848e9c' },
    grid: { vertLines: { color: '#1e2026' }, horzLines: { color: '#1e2026' } },
    timeScale: { borderColor: '#262930', timeVisible: true },
    rightPriceScale: { borderColor: '#262930' },
    crosshair: { mode: 0 },
});
const candleSeries = chart.addCandlestickSeries({ upColor: '#0ecb81', downColor: '#f6465d', borderVisible: false, wickUpColor: '#0ecb81', wickDownColor: '#f6465d' });

const canvas = document.getElementById('draw-layer');
const ctx = canvas.getContext('2d');
new ResizeObserver(entries => {
    const { width, height } = entries[0].contentRect;
    chart.applyOptions({ width, height });
    canvas.width = width; canvas.height = height;
    draw();
}).observe(document.getElementById('chart-container'));

// --- 4. DATA FEED (Upbit) ---
async function fetchUpbitKlineData(market, unit, interval, count = 200) {
    try {
        const url = `https://api.upbit.com/v1/candles/${unit}/${interval}?market=${market}&count=${count}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('Upbit Kline API Network response was not ok');
        const data = await response.json();
        return data.map(d => ({
            time: new Date(d.candle_date_time_utc).getTime() / 1000,
            open: d.opening_price,
            high: d.high_price,
            low: d.low_price,
            close: d.trade_price,
        })).reverse();
    } catch (error) {
        console.error(`Failed to fetch kline data for ${market}:`, error);
        return [];
    }
}

async function updateRealtimeData() {
    try {
        const response = await fetch(`https://api.upbit.com/v1/ticker?markets=${SYMBOL}`);
        if (!response.ok) return;
        const data = await response.json();
        const ticker = data[0];
        if (!ticker) return;

        const newPrice = ticker.trade_price;
        const prev = state.price;
        state.price = newPrice;
        
        // Update Chart
        const lastCandle = candleSeries.dataByIndex(candleSeries.data().length - 1);
        if (lastCandle) {
            const updatedCandle = { ...lastCandle, close: newPrice };
            if (newPrice > updatedCandle.high) updatedCandle.high = newPrice;
            if (newPrice < updatedCandle.low) updatedCandle.low = newPrice;
            candleSeries.update(updatedCandle);
        }

        // Update Header
        document.getElementById('head-price').innerText = newPrice.toLocaleString();
        document.getElementById('head-price').className = `tg-val ${newPrice >= prev ? 'up' : 'down'}`;
        document.getElementById('head-chg').innerText = (ticker.signed_change_rate * 100).toFixed(2) + '%';
        document.getElementById('head-high').innerText = ticker.high_price.toLocaleString();
        document.getElementById('head-low').innerText = ticker.low_price.toLocaleString();

        // Update Mid Price
        const midEl = document.getElementById('mid-price');
        const arrowEl = document.getElementById('mid-arrow');
        midEl.innerText = newPrice.toLocaleString();
        midEl.className = `mid-price ${newPrice >= prev ? 'text-up' : 'text-down'}`;
        arrowEl.innerText = newPrice >= prev ? '▲' : '▼';
        arrowEl.className = `mid-arrow ${newPrice >= prev ? 'text-up' : 'text-down'}`;

        checkTpSl();
        updatePosBadge();
        renderPosTable();

    } catch(e) { console.error(e) }
}

async function init() {
    loadState();
    let [unit, interval] = getTfUnit(state.tf);
    const bars = await fetchUpbitKlineData(SYMBOL, unit, interval);
    candleSeries.setData(bars);
    if(bars.length) state.price = bars[bars.length - 1].close;

    // Init Fake Orderbook
    let p = state.price;
    state.asks = Array.from({length:15}, (_,i) => ({p:p+(i+1)*1000, q:Math.random()}));
    state.bids = Array.from({length:15}, (_,i) => ({p:p-(i+1)*1000, q:Math.random()}));

    // Start Polling
    updateRealtimeData();
    setInterval(updateRealtimeData, 2000); // Poll every 2 seconds
}


// Fake Activity Loop (0.05s) for order book
setInterval(() => {
    const target = Math.random() > 0.5 ? state.asks : state.bids;
    if(target.length) {
        const idx = Math.floor(Math.random()*10);
        target[idx].q += (Math.random()-0.5)*0.5;
        if(target[idx].q < 0) target[idx].q = 0.05;
    }
    renderOrderBook();
}, 50);

function renderOrderBook() {
    const askEl = document.getElementById('asks');
    const bidEl = document.getElementById('bids');
    const draw = (arr, type) => arr.slice(0,14).map(x => {
        let w = Math.min(100, x.q*20);
        let bgClass = type==='ask'?'bg-ask':'bg-bid';
        let txtClass = type==='ask'?'text-down':'text-up';
        return `<div class="ob-row" onclick="setPrice(${x.p})">
            <div class="bg-bar ${bgClass}" style="width:${w}%"></div>
            <span class="ob-price ${txtClass}">${x.p.toLocaleString()}</span>
            <span class="ob-qty">${Math.abs(x.q).toFixed(3)}</span>
            <span class="ob-total">${(x.p*x.q/1000000).toFixed(1)}M</span>
        </div>`
    }).join('');
    askEl.innerHTML = draw(state.asks, 'ask');
    bidEl.innerHTML = draw(state.bids, 'bid');
}

// --- 5. TRADING LOGIC ---
function setPrice(p) { document.getElementById('inp-price').value = p; calcCost(); }

function calcCost() {
    let p = parseFloat(document.getElementById('inp-price').value) || state.price;
    let q = parseFloat(document.getElementById('inp-qty').value) || 0;
    document.getElementById('cost-disp').innerText = ((p*q)/state.lev).toLocaleString(undefined, {maximumFractionDigits: 0}) + " KRW";
}

function setQtyPct(pct) {
    let p = parseFloat(document.getElementById('inp-price').value) || state.price;
    if(p === 0) return;
    let max = (state.balance * state.lev) / p;
    document.getElementById('inp-qty').value = (max * (pct/100)).toFixed(3);
    calcCost();
}

function syncSlider(val) {
    let p = parseFloat(document.getElementById('inp-price').value) || state.price;
    if(p === 0) return;
    let max = (state.balance * state.lev) / p;
    document.getElementById('slider-qty').value = (val/max)*100;
    calcCost();
}

function openPos(side) {
    let q = parseFloat(document.getElementById('inp-qty').value);
    let p = parseFloat(document.getElementById('inp-price').value) || state.price;
    if(!q || p === 0) { playSound('error'); return showToast('수량과 가격을 확인해주세요.'); }
    
    let cost = (p*q)/state.lev;
    if(cost > state.balance) { playSound('error'); return showToast('잔고가 부족합니다.'); }
    
    let fee = -(p * q * 0.0005); // Upbit fee ~0.05%
    state.balance -= cost;
    state.pos = { side, qty: q, entry: p, lev: state.lev, mode: state.mode, realized: fee, tp: 0, sl: 0 };
    
    playSound(side==='long'?'buy':'sell');
    saveState();
    renderPosTable();
    updateBal();
    showToast('주문이 체결되었습니다.');
}

function closePosition() {
    if(!state.pos) return;
    let p = state.price;
    let pnl = (p - state.pos.entry) * state.pos.qty * (state.pos.side==='long'?1:-1);
    let margin = (state.pos.qty * state.pos.entry) / state.pos.lev;
    let fee = -(p * state.pos.qty * 0.0005);
    
    state.balance += (margin + pnl + fee); // Realized PNL doesn't exist yet, so add fee directly
    state.pos = null;
    
    playSound('close');
    saveState();
    renderPosTable();
    updateBal();
    updatePosBadge();
    showToast('포지션이 시장가로 종료되었습니다.');
}

function renderPosTable() {
    const tbody = document.getElementById('pos-body');
    if(!state.pos) { tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:#555">보유 중인 포지션이 없습니다.</td></tr>`; return; }
    
    let p = state.pos;
    let cur = state.price;
    let pnl = (cur - p.entry) * p.qty * (p.side==='long'?1:-1);
    let roe = (pnl / ((p.qty*p.entry)/p.lev)) * 100;
    let colorClass = pnl >= 0 ? 'text-up' : 'text-down';
    
    let liq = p.side==='long' ? p.entry*(1 - (1/p.lev)*0.99) : p.entry*(1 + (1/p.lev)*0.99); // Simplified liq price

    tbody.innerHTML = `<tr>
        <td>
            <div style="display:flex;align-items:center;gap:6px">
                <span class="${p.side==='long'?'text-up':'text-down'}" style="font-weight:900;font-size:14px">${p.side==='long'?'Long':'Short'}</span>
                <span style="font-weight:700">${SYMBOL}</span>
            </div>
            <div style="font-size:10px;background:#333;padding:2px 4px;border-radius:3px;width:fit-content;margin-top:4px;color:#aaa">${p.mode} ${p.lev}x</div>
        </td>
        <td>${p.qty.toFixed(3)}</td>
        <td>${(p.qty*cur).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
        <td>${p.entry.toLocaleString()}</td>
        <td class="${colorClass}">${cur.toLocaleString()}</td>
        <td style="color:var(--accent)">${liq.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
        <td>
            <div class="${colorClass}" style="font-weight:700">${pnl.toLocaleString(undefined, {maximumFractionDigits: 0})} KRW</div>
            <div class="${colorClass}" style="font-size:11px">${roe.toFixed(2)}%</div>
        </td>
        <td class="text-down">${p.realized.toLocaleString(undefined, {maximumFractionDigits: 0})} KRW</td>
        <td>--</td>
        <td><button class="btn-action" onclick="closePosition()">시장가 종료</button></td>
    </tr>`;
}

function checkTpSl() {}

// --- 6. DRAWING TOOLS ---
let tool = 'cursor', isDraw = false, startPt = null;
function setTool(t) {
    tool = t;
    document.querySelectorAll('.dt-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.dt-btn[onclick*="${t}"]`).classList.add('active');
    
    if(t !== 'cursor') {
        chart.applyOptions({ handleScroll: false, handleScale: false });
        document.getElementById('draw-layer').style.pointerEvents = 'auto';
        showToast(`${t==='line'?'추세선':'가로줄'} 그리기 모드`);
    } else {
        chart.applyOptions({ handleScroll: {mouseWheel:true, pressedMouseMove:true}, handleScale: {axisPressedMouseMove:true, mouseWheel:true, pinch:true} });
        document.getElementById('draw-layer').style.pointerEvents = 'none';
    }
    if(t==='eraser'){ state.drawings = []; draw(); saveState(); setTool('cursor'); showToast('모든 드로잉 삭제됨'); }
}
canvas.addEventListener('mousedown', e => {
    if (tool === 'cursor') return;
    const r = canvas.getBoundingClientRect();
    startPt = { x: e.clientX - r.left, y: e.clientY - r.top };
    startPt.t = chart.timeScale().coordinateToTime(startPt.x);
    startPt.p = candleSeries.coordinateToPrice(startPt.y);
    isDraw = true;
});
canvas.addEventListener('mousemove', e => {
    if(!isDraw) return;
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    draw();
    ctx.beginPath(); ctx.strokeStyle = '#f7a600'; ctx.lineWidth = 2;
    const x1 = chart.timeScale().timeToCoordinate(startPt.t);
    const y1 = candleSeries.priceToCoordinate(startPt.p);
    ctx.moveTo(x1, y1);
    if(tool === 'hline') ctx.lineTo(canvas.width, y1);
    else ctx.lineTo(x, y);
    ctx.stroke();
});
canvas.addEventListener('mouseup', e => {
    if (!isDraw) return;
    const r = canvas.getBoundingClientRect();
    const t = chart.timeScale().coordinateToTime(e.clientX - r.left);
    const p = candleSeries.coordinateToPrice(e.clientY - r.top);
    if(tool === 'hline') state.drawings.push({ type:'h', p: startPt.p });
    else if(tool === 'line') state.drawings.push({ type:'l', t1: startPt.t, p1: startPt.p, t2: t, p2: p });
    isDraw = false;
    draw();
    saveState();
});
chart.timeScale().subscribeVisibleTimeRangeChange(draw);
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    state.drawings.forEach(d => {
        ctx.beginPath(); ctx.strokeStyle = '#f7a600'; ctx.lineWidth = 2;
        if(d.type === 'h') {
            const y1 = candleSeries.priceToCoordinate(d.p);
            if(y1) { ctx.moveTo(0, y1); ctx.lineTo(canvas.width, y1); }
        } else {
            const x1 = chart.timeScale().timeToCoordinate(d.t1);
            const y1 = candleSeries.priceToCoordinate(d.p1);
            const x2 = chart.timeScale().timeToCoordinate(d.t2);
            const y2 = candleSeries.priceToCoordinate(d.p2);
            if(x1 && y1 && x2 && y2) { ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); }
        }
        ctx.stroke();
    });
}

// --- 7. UTILS & MODALS ---
function updateBal() { document.getElementById('balance').innerText = Math.floor(state.balance).toLocaleString(); }
function updatePosBadge() {
    const b = document.getElementById('pos-badge');
    if(!state.pos) { b.style.display='none'; return; }
    const y = candleSeries.priceToCoordinate(state.pos.entry);
    if(y) {
        b.style.display='block'; b.style.top = y + 'px'; b.style.left = '50%';
        let pnl = (state.price - state.pos.entry) * state.pos.qty * (state.pos.side==='long'?1:-1);
        document.getElementById('pb-pnl').innerText = (pnl>0?'+':'') + pnl.toLocaleString(undefined, {maximumFractionDigits: 0});
        document.getElementById('pb-pnl').className = pnl>=0?'text-up':'text-down';
        document.getElementById('pb-qty').innerText = state.pos.qty + ' BTC';
    } else b.style.display='none';
}
function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display='block';
    setTimeout(()=>t.style.display='none', 2000);
}
function openMarginModal() { 
    document.getElementById('modal-margin').style.display='flex'; 
    document.getElementById('modal-lev-val').innerText = state.lev + 'x';
}
function closeModal(id) { document.getElementById(id).style.display='none'; }
function setMarginMode(m) { 
    state.mode = m; 
    document.getElementById('tab-cross').className = m==='Cross'?'mm-tab active':'mm-tab';
    document.getElementById('tab-isolated').className = m==='Isolated'?'mm-tab active':'mm-tab';
}
function updateModalLev(v) { state.lev = v; document.getElementById('modal-lev-val').innerText = v+'x'; }
function confirmMargin() {
    document.getElementById('lev-disp').innerText = state.lev + 'x';
    closeModal('modal-margin');
    saveState();
    showToast(`레버리지 ${state.lev}x 설정 완료`);
}

function getTfUnit(tf) {
    if (['D', 'W', 'M'].includes(tf)) return ['days', 1]; // Upbit doesn't support W/M in the same way, simplifying to days
    return ['minutes', tf];
}

function setTF(tf) {
    state.tf = tf;
    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    init(); // Reload chart
}

setInterval(()=>document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

init(); // Start!
</script>
</body>
</html>